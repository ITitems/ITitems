<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="RentalDAO">
	
	<resultMap type="egovframework.let.rent.service.RentalVO"
		id="rentalList">
		<result property="rentalId" column="RENTAL_ID" />
		<result property="middleCategory" column="MIDDLE_CATEGORY" />
		<result property="orgnztNm" column="ORGNZT_NM" />
		<result property="lowerOrgnztNm" column="LOWER_ORGNZT_NM" />
		<result property="prjNm" column="PRJ_NM" />
		<result property="rentalQty" column="RENTAL_QTY" />
		<result property="rcptNm" column="RCPT_NM" />
		<result property="useNm" column="USE_NM" />
	</resultMap>
	<resultMap type="egovframework.let.rent.service.RentalVO"
		id="myRentalList">
		<result property="rentalId" column="RENTAL_ID" />
		<result property="middleCategory" column="MIDDLE_CATEGORY" />
		<result property="assetName" column="ASSET_NAME" />
		<result property="assetSn" column="ASSET_SN" />
		<result property="prjNm" column="PRJ_NM" />
		<result property="rentalQty" column="RENTAL_QTY" />
		<result property="rcptNm" column="RCPT_NM" />
		<result property="useNm" column="USE_NM" />
	</resultMap>
	
	<resultMap type="egovframework.let.rent.service.RentalVO"
		id="rentalDetail">
		
	</resultMap>
	
	<sql id="search">
		<where>
			AND A.USAGE_STAUTS = 'Y'
			AND B.USAGE_STAUTS = 'Y'
			AND C.USAGE_STAUTS = 'Y'
			AND D.HIST_STATUS = 'Y'
			<if test="searchOrgnzt != null and searchOrgnzt != ''">
              	AND (	D.ORGNZT_ID = #{searchOrgnzt} 
              		OR  I.ORGNZT_UP = #{searchOrgnzt})
            </if>
            <if test="userId != null and userId != ''">
				AND (	B.RCPT_ID = #{userId} 
					OR  D.USE_ID = #{userId})
            </if>
        	<if test="lowerOrgnzt != null and lowerOrgnzt != ''">
				AND D.ORGNZT_ID = #{lowerOrgnzt}
			</if>
			<if test="searchPrj != null and searchPrj != ''">
				AND D.PRJ_ID = #{searchPrj}
			</if>
			<if test="searchLCat != null and searchLCat != ''">
				AND B.LARGE_CATEGORY = #{searchLCat}
			</if>
			<if test="searchdMCat != null and searchdMCat != ''">
				AND B.MIDDLE_CATEGORY = #{searchdMCat}
			</if>
			<if test="searchStatus != null and searchStatus != ''">
				AND B.HIST_GROUP = #{searchStatus}
			</if>
			<if test="startDate != null and startDate != ''">
				AND DATE_FORMAT(A.REG_DATE, '%Y-%m-%d') >= STR_TO_DATE(#{startDate},
				'%Y-%m-%d')
			</if>
			<if test="endDate != null and endDate != ''">
				<![CDATA[
				AND DATE_FORMAT(A.REG_DATE, '%Y-%m-%d') <= STR_TO_DATE(#{endDate}, '%Y-%m-%d')
				]]>
			</if>
		</where>
	</sql>
	
	<sql id="mySearch">
		<where>
			AND A.USAGE_STAUTS = 'Y'
			AND B.USAGE_STAUTS = 'Y'
			AND C.USAGE_STAUTS = 'Y'
			AND D.HIST_STATUS = 'Y'
			AND (	B.RCPT_ID = #{userId} 
				OR  D.USE_ID = #{userId})
			<if test="searchWord != null and searchWord != ''">
				AND (	B.ASSET_NAME LIKE CONCAT ('%', #{searchWord},'%') 
					OR  B.ASSET_SN LIKE CONCAT ('%', #{searchWord},'%'))
		 	</if>
			<if test="searchPrj != null and searchPrj != ''">
				AND D.PRJ_ID = #{searchPrj}
			</if>
			<if test="searchLCat != null and searchLCat != ''">
				AND B.LARGE_CATEGORY = #{searchLCat}
			</if>
			<if test="searchdMCat != null and searchdMCat != ''">
				AND B.MIDDLE_CATEGORY = #{searchdMCat}
			</if>
			<if test="startDate != null and startDate != ''">
				AND A.REG_DATE >= STR_TO_DATE(#{startDate},
				'%Y-%m-%d')
			</if>
			<if test="endDate != null and endDate != ''">
				<![CDATA[
				AND DATE_FORMAT(A.REG_DATE, '%Y-%m-%d') <= STR_TO_DATE(#{endDate}, '%Y-%m-%d')
				]]>
			</if>
		</where>
	</sql>

	<select id="SelectMyRentalVOList" parameterType="egovframework.let.rent.service.RentalManageVO" resultMap="myRentalList">
		SELECT 
    		RENTAL_ID, 
			MIDDLE_CATEGORY, 
			ASSET_NAME, 
			ASSET_SN,
			PRJ_NM,
			RENTAL_QTY,
			RCPT_NM,
			USE_NM
	      FROM (
			SELECT 
				ROW_NUMBER() OVER(ORDER BY A.REG_DATE DESC)AS RUM,
				A.RENTAL_ID, 
				CASE 
					WHEN E.CAT_NAME = '기타' AND B.MCAT_ETC IS NOT NULL
					THEN B.MCAT_ETC
					ELSE E.CAT_NAME
				END AS MIDDLE_CATEGORY, 
				B.ASSET_NAME, 
				B.ASSET_SN,
				F.PRJ_NAME AS PRJ_NM,
				COUNT(C.R_ID) AS RENTAL_QTY,
				G.USER_NM AS RCPT_NM,
				H.USER_NM AS USE_NM
			  FROM RENTALASSET A
   LEFT OUTER JOIN RENTALDETAIL B
				ON A.RENTAL_ID = B.RENTAL_ID
   LEFT OUTER JOIN RENTALINDIV C
				ON A.RENTAL_ID = C.RENTAL_ID			
   LEFT OUTER JOIN RENTALHIST D
				ON C.R_ID = D.R_ID
   LEFT OUTER JOIN CATEGORY E
				ON B.MIDDLE_CATEGORY = E.CAT_ID
   LEFT OUTER JOIN PROJECTS F
	   			ON D.PRJ_ID = F.PRJ_ID
   LEFT OUTER JOIN LETTNEMPLYRINFO G
	            ON B.RCPT_ID = G.ESNTL_ID
   LEFT OUTER JOIN LETTNEMPLYRINFO H
	            ON D.USE_ID = H.ESNTL_ID
				 <include refid="mySearch" />
		  GROUP BY  
				A.RENTAL_ID, 
				E.CAT_NAME,
				B.MCAT_ETC,
				B.ASSET_NAME,
				B.ASSET_SN,
				F.PRJ_NAME,
				G.USER_NM,
				H.USER_NM,
				A.REG_DATE
		    ) P 
	    WHERE P.RUM BETWEEN #{first} AND #{last}
	</select>
	
	<select id="CountMyRentalVOList" parameterType="egovframework.let.rent.service.RentalManageVO" resultType="int">
		SELECT 
    		COUNT(P.RENTAL_ID)
	      FROM (
			SELECT 
				A.RENTAL_ID, 
				COUNT(C.R_ID) AS ASSET_QTY
			  FROM RENTALASSET A
   LEFT OUTER JOIN RENTALDETAIL B
				ON A.RENTAL_ID = B.RENTAL_ID
   LEFT OUTER JOIN RENTALINDIV C
				ON A.RENTAL_ID = C.RENTAL_ID			
   LEFT OUTER JOIN RENTALHIST D
				ON C.R_ID = D.R_ID
				 <include refid="mySearch" />
		  GROUP BY  
				A.RENTAL_ID
		    ) P 
	</select>

	<select id="SelectRentalVOList" parameterType="egovframework.let.rent.service.RentalManageVO" resultMap="rentalList">
		SELECT 
    		RENTAL_ID, 
			ORGNZT_NM,
	    	LOWER_ORGNZT_NM, 
			PRJ_NM,
			MIDDLE_CATEGORY,
			RENTAL_QTY,
			RCPT_NM,
			USE_NM
	      FROM (
			SELECT 
				ROW_NUMBER() OVER(ORDER BY A.REG_DATE DESC)AS RUM,
				A.RENTAL_ID,
				CASE
					WHEN I.ORGNZT_UP IS NULL
					THEN I.ORGNZT_NM
					ELSE J.ORGNZT_NM
				 END AS ORGNZT_NM,
				CASE 
					WHEN I.ORGNZT_UP IS NULL
					THEN NULL
					ELSE I.ORGNZT_NM
				 END AS LOWER_ORGNZT_NM,
				F.PRJ_NAME AS PRJ_NM,
				CASE 
					WHEN E.CAT_NAME = '기타' AND B.MCAT_ETC IS NOT NULL
					THEN B.MCAT_ETC
					ELSE E.CAT_NAME
				END AS MIDDLE_CATEGORY, 
				COUNT(C.R_ID) AS RENTAL_QTY,
				G.USER_NM AS RCPT_NM,
				H.USER_NM AS USE_NM
			  FROM RENTALASSET A
   LEFT OUTER JOIN RENTALDETAIL B
				ON A.RENTAL_ID = B.RENTAL_ID
   LEFT OUTER JOIN RENTALINDIV C
				ON A.RENTAL_ID = C.RENTAL_ID
   LEFT OUTER JOIN RENTALHIST D
				ON C.R_ID = D.R_ID
   LEFT OUTER JOIN CATEGORY E
				ON B.MIDDLE_CATEGORY = E.CAT_ID
   LEFT OUTER JOIN PROJECTS F
	   			ON D.PRJ_ID = F.PRJ_ID
   LEFT OUTER JOIN LETTNEMPLYRINFO G
	            ON B.RCPT_ID = G.ESNTL_ID
   LEFT OUTER JOIN LETTNEMPLYRINFO H
	            ON D.USE_ID = H.ESNTL_ID
   LEFT OUTER JOIN LETTNORGNZTINFO I
				ON D.ORGNZT_ID = I.ORGNZT_ID
   LEFT OUTER JOIN LETTNORGNZTINFO J
				ON I.ORGNZT_UP = J.ORGNZT_ID
				 <include refid="search" />
		  GROUP BY  
				A.RENTAL_ID, 
				E.CAT_NAME,
				B.MCAT_ETC,
				F.PRJ_NAME,
				G.USER_NM,
				H.USER_NM,
				A.REG_DATE,
				I.ORGNZT_UP,
				I.ORGNZT_NM
		    ) P 
	    WHERE P.RUM BETWEEN #{first} AND #{last}
	</select>
	
	<select id="CountRentalVOList" parameterType="egovframework.let.rent.service.RentalManageVO" resultType="int">
		SELECT 
    		COUNT(P.RENTAL_ID)
	      FROM (
			SELECT 
				A.RENTAL_ID, 
				COUNT(C.R_ID) AS ASSET_QTY
			  FROM RENTALASSET A
   LEFT OUTER JOIN RENTALDETAIL B
				ON A.RENTAL_ID = B.RENTAL_ID
   LEFT OUTER JOIN RENTALINDIV C
				ON A.RENTAL_ID = C.RENTAL_ID
   LEFT OUTER JOIN RENTALHIST D
				ON C.R_ID = D.R_ID
				 <include refid="search" />
		  GROUP BY  
				A.RENTAL_ID
		    ) P
	</select>

	<select id="SelectRentalVO" parameterType="egovframework.let.rent.service.RentalManageVO" resultMap="rentalDetail">
		SELECT 
			A.RENTAL_ID, 
			DATE_FORMAT(A.REG_DATE,'%Y-%m-%d') AS REG_DATE, 
			REG_ID, 
			COUNT(C.R_ID) AS RENTAL_QTY, 
			LARGE_CATEGORY, 
			MIDDLE_CATEGORY, 
			MCAT_ETC, 
			ASSET_NAME, 
			RENTAL_START, 
			RENTAL_END, 
			RENTAL_PRICE, 
			RENTAL_COMPANY, 
			MAKER, 
			MAKER_CODE, 
			NOTE, 
			ASSET_SN, 
			MNG_NUM, 
			RCPT_ID
		   FROM RENTALASSET A
   LEFT OUTER JOIN RENTALDETAIL B
				ON A.RENTAL_ID = B.RENTAL_ID
   LEFT OUTER JOIN RENTALINDIV C
				ON A.RENTAL_ID = C.RENTAL_ID
   LEFT OUTER JOIN RENTALHIST D
				ON C.R_ID = D.R_ID
			 WHERE A.RENTAL_ID = #{rentalId}
	</select>

	<insert id="InsertRental" parameterType="egovframework.let.rent.service.RentalVO">
		INSERT INTO RENTALASSET (
			RENTAL_ID, 
			REG_DATE, 
			REG_ID, 
			RENTAL_QTY, 
			USAGE_STAUTS
			)
		VALUES (
			#{rentalId},
			DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s'),
			#{regId},
			#{rentalQty},
			'Y'
		)
	</insert>
	
	<insert id="InsertRentaldetail" parameterType="egovframework.let.rent.service.RentalVO">
		INSERT INTO RENTALDETAIL (
			RENTAL_ID, 
			LARGE_CATEGORY, 
			MIDDLE_CATEGORY, 
			MCAT_ETC, 
			ASSET_NAME,  
			RENTAL_COMPANY, 
			MAKER, 
			MAKER_CODE, 
			NOTE, 
			ASSET_SN, 
			MNG_NUM, 
			USAGE_STAUTS,
			RCPT_ID
			)
		VALUES (
			#{rentalId},
			#{largeCategory},
			#{middleCategory},
			#{mcatEtc},
			#{assetName},
			#{rentalCompany},
			#{maker},
			#{makerCode},
			#{note},
			#{assetSn},
			#{mngNum},
			'Y',
			#{rcptId}
		)
	</insert>
	
	<insert id="InsertRentalIndiv" parameterType="egovframework.let.rent.service.RentalVO">
		INSERT INTO RENTALINDIV (
			R_ID, 
			RENTAL_ID,
			USAGE_STAUTS
			)
		VALUES (
			#{rId},
			#{rentalId},
			'Y'
		)
	</insert>
	
	<insert id="InsertRentalhist" parameterType="egovframework.let.rent.service.RentalVO">
		 INSERT INTO RENTALHIST (
			HIST_ID, 
			R_ID, 
			ORGNZT_ID, 
			PRJ_ID, 
			USE_ID, 
			HIST_STATUS, 
			HIST_DATE, 
			CREAT_DT,
			HIST_USER,
			HIST_GROUP
			)
		VALUES (
			#{histId},
			#{rId},
			#{orgnztId},
			#{prjId},
			#{useId},
			'Y',
			<if test="histDate != null and histDate != ''">
			DATE_FORMAT(#{histDate}, '%Y-%m-%d'),
			</if>
			DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s'),
			#{histUser},
			#{histGroup}
		)
	</insert>
	
	
</mapper>