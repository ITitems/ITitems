<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="AssetInfoDAO">
	
	<resultMap type="egovframework.let.ass.service.AssetInfoVO"
		id="assetInfoList">
		<result property="assetId" column="ASSET_ID" />
		<result property="largeCategory" column="LARGE_CATEGORY" />
		<result property="middleCategory" column="MIDDLE_CATEGORY" />
		<result property="assetName" column="ASSET_NAME" />
		<result property="assetQty" column="ASSET_QTY" />
		<result property="acquiredDate" column="ACQUIRED_DATE" />
		<result property="acquiredPrice" column="ACQUIRED_PRICE" />
		<result property="regDate" column="REG_DATE" />
		<result property="usageStatus" column="USAGE_STAUTS" />
	</resultMap>
	
	<resultMap type="egovframework.let.ass.service.AssetInfoVO"
		id="myAssetList">
		<result property="assetId" column="ASSET_ID" />
		<result property="largeCategory" column="LARGE_CATEGORY" />
		<result property="middleCategory" column="MIDDLE_CATEGORY" />
		<result property="assetName" column="ASSET_NAME" />
		<result property="assetQty" column="ASSET_QTY" />
		<result property="prjId" column="PRJ_ID" />
		<result property="regDate" column="REG_DATE" />
		<result property="usageStatus" column="USAGE_STAUTS" />
	</resultMap>
	
	<resultMap type="egovframework.let.ass.service.AssetInfoVO"
		id="assetInfoDetail">
		<result property="assetId" column="ASSET_ID" />
		<result property="largeCategory" column="LARGE_CATEGORY" />
		<result property="middleCategory" column="MIDDLE_CATEGORY" />
		<result property="assetName" column="ASSET_NAME" />
		<result property="assetQty" column="ASSET_QTY" />
		<result property="acquiredDate" column="ACQUIRED_DATE" />
		<result property="acquiredPrice" column="ACQUIRED_PRICE" />
		<result property="maker" column="MAKER" />
		<result property="note" column="NOTE" />
		<result property="regDate" column="REG_DATE" />
		<result property="assetSn" column="ASSET_SN" />
		<result property="fileId" column="FILE_ID" />
		<result property="orgnztId" column="ORGNZT_ID" />
		<result property="prjId" column="PRJ_ID" />
		<result property="prjNm" column="PRJ_NM" />
		<result property="useId" column="USE_ID" />
		<result property="useNm" column="USE_NM" />
		<result property="rcptDate" column="RCPT_DATE" />
		<result property="rcptId" column="RCPT_ID" />
		<result property="rcptNm" column="RCPT_NM" />
		<result property="carryReason" column="CARRY_REASON" />
	</resultMap>
	
	<sql id="search">
		<where>
			<if test="searchOrgnzt != null and searchOrgnzt != '' and !searchLOrgnzt">
				AND B.ORGNZT_ID = #{searchOrgnzt}
				 OR G.ORGNZT_UP = #{searchOrgnzt}
			</if>
			<if test="searchLOrgnzt != null and searchLOrgnzt != ''">
				AND B.ORGNZT_ID = #{searchLOrgnzt}
			</if>
			<if test="searchPrj != null and searchPrj != ''">
				AND B.PRJ_ID = #{searchPrj}
			</if>
			<if test="searchLCat != null and searchLCat != ''">
				AND A.LARGE_CATEGORY = #{searchLCat}
			</if>
			<if test="searchdMCat != null and searchdMCat != ''">
				AND A.MIDDLE_CATEGORY = #{searchdMCat}
			</if>
			<if test="searchStatus != null and searchStatus != ''">
				AND B.HIST_GROUP = #{searchStatus}
			</if>
			<if test="startDate != null and startDate != ''">
				AND DATE_FORMAT(A.REG_DATE, '%Y-%m-%d') >= STR_TO_DATE(#{startDate},
				'%Y-%m-%d')
			</if>
			<if test="endDate != null and endDate != ''">
				<![CDATA[
				AND DATE_FORMAT(A.REG_DATE, '%Y-%m-%d') <= STR_TO_DATE(#{endDate}, '%Y-%m-%d')
				]]>
			</if>
			<if test="searchWord != null and searchWord != ''">
				AND A.ASSET_NAME LIKE CONCAT ('%', #{searchWord},'%')
			</if>
		</where>
	</sql>

	<sql id="mySearch">
			<if test="searchPrj != null and searchPrj != ''">
				AND B.PRJ_ID = #{searchPrj}
			</if>
			<if test="searchLCat != null and searchLCat != ''">
				AND A.LARGE_CATEGORY = #{searchLCat}
			</if>
			<if test="searchdMCat != null and searchdMCat != ''">
				AND A.MIDDLE_CATEGORY = #{searchdMCat}
			</if>
			<if test="startDate != null and startDate != ''">
				AND A.REG_DATE >= STR_TO_DATE(#{startDate},
				'%Y-%m-%d')
			</if>
			<if test="endDate != null and endDate != ''">
				<![CDATA[
				AND DATE_FORMAT(A.REG_DATE, '%Y-%m-%d') <= STR_TO_DATE(#{endDate}, '%Y-%m-%d')
				]]>
			</if>
			<if test="searchWord != null and searchWord != ''">
				AND A.ASSET_NAME LIKE CONCAT ('%', #{searchWord},'%')
			</if>
	</sql>

	<select id="SelectAssetInfoVOList"
		parameterType="egovframework.let.ass.service.AssetManageVO"
		resultMap="assetInfoList">
		
	    SELECT 
	    	   ASSET_ID,
	    	   LARGE_CATEGORY, 
	    	   MIDDLE_CATEGORY, 
	    	   ASSET_NAME, 
	    	   ASSET_QTY, 
	    	   ACQUIRED_DATE,
	    	   ACQUIRED_PRICE,
	    	   REG_DATE,
	    	   USAGE_STAUTS
	      FROM (
		        SELECT 
					ROW_NUMBER() OVER(ORDER BY A.REG_DATE DESC)AS RUM,
					A.ASSET_ID,
					C.CAT_NAME AS LARGE_CATEGORY, 
					D.CAT_NAME AS MIDDLE_CATEGORY,
					A.ASSET_NAME,
					A.ASSET_QTY, 
					DATE_FORMAT(A.ACQUIRED_DATE,'%Y-%m-%d') AS ACQUIRED_DATE, 
					A.ACQUIRED_PRICE, 
					DATE_FORMAT(A.REG_DATE,'%Y-%m-%d') AS REG_DATE, 
					E.CODE_NM AS USAGE_STAUTS
				  FROM ASSETSINFO A 
	   LEFT OUTER JOIN ASSETSHIST B
				    ON A.ASSET_ID = B.ASSET_ID
	   LEFT OUTER JOIN CATEGORY C
				    ON A.LARGE_CATEGORY = C.CAT_ID
	   LEFT OUTER JOIN CATEGORY D
				    ON A.MIDDLE_CATEGORY = D.CAT_ID
	   LEFT OUTER JOIN LETTCCMMNDETAILCODE E
				    ON A.USAGE_STAUTS = E.CODE
	   LEFT OUTER JOIN LETTCCMMNDETAILCODE F
				    ON B.APPROVAL = F.CODE
	   LEFT OUTER JOIN LETTNORGNZTINFO G
	   				ON B.ORGNZT_ID = G.ORGNZT_ID
		        	<include refid="search" />
		    ) P 
	    WHERE P.RUM BETWEEN #{first} AND #{last}
	</select>
	
	<select id="CountAssetInfoVOList"
		parameterType="egovframework.let.ass.service.AssetManageVO"
		resultType="int">
		SELECT COUNT(A.ASSET_ID)
		  FROM ASSETSINFO A
		  LEFT OUTER JOIN ASSETSHIST B
		    ON A.ASSET_ID = B.ASSET_ID
		  LEFT OUTER JOIN LETTNORGNZTINFO G
	   		ON B.ORGNZT_ID = G.ORGNZT_ID
		<include refid="search" />
	</select>
	
	<select id="SelectMyAssetInfoList" parameterType="egovframework.let.ass.service.AssetManageVO"
		resultMap="myAssetList">
		
	    SELECT 
	    	   ASSET_ID,
	    	   LARGE_CATEGORY, 
	    	   MIDDLE_CATEGORY, 
	    	   ASSET_NAME, 
	    	   ASSET_QTY, 
	    	   PRJ_ID,
	    	   REG_DATE,
	    	   USAGE_STAUTS
	      FROM (
		        SELECT 
					ROW_NUMBER() OVER(ORDER BY A.REG_DATE DESC)AS RUM,
					A.ASSET_ID,
					C.CAT_NAME AS LARGE_CATEGORY, 
					D.CAT_NAME AS MIDDLE_CATEGORY,
					A.ASSET_NAME,
					A.ASSET_QTY,
					G.PRJ_NAME AS PRJ_ID,
					DATE_FORMAT(A.REG_DATE,'%Y-%m-%d') AS REG_DATE, 
					E.CODE_NM AS USAGE_STAUTS
				  FROM ASSETSINFO A
				  LEFT OUTER JOIN ASSETSHIST B
				    ON A.ASSET_ID = B.ASSET_ID
				  LEFT OUTER JOIN CATEGORY C
				    ON A.LARGE_CATEGORY = C.CAT_ID
				  LEFT OUTER JOIN CATEGORY D
				    ON A.MIDDLE_CATEGORY = D.CAT_ID
				  LEFT OUTER JOIN LETTCCMMNDETAILCODE E
				    ON A.USAGE_STAUTS = E.CODE
				  LEFT OUTER JOIN LETTCCMMNDETAILCODE F
				    ON B.APPROVAL = F.CODE
				  LEFT OUTER JOIN PROJECTS G
				    ON B.PRJ_ID = G.PRJ_ID
				 WHERE B.USE_ID = #{userId}
		        	<include refid="mySearch" />
		    ) P 
	    WHERE P.RUM BETWEEN #{first} AND #{last}
	</select>
	
	<select id="CountMyAssetInfoList" parameterType="egovframework.let.ass.service.AssetManageVO"
		resultType="int">
		SELECT 
			COUNT(A.ASSET_ID)
		  FROM ASSETSINFO A
		  LEFT OUTER JOIN ASSETSHIST B
		    ON A.ASSET_ID = B.ASSET_ID
		 WHERE B.USE_ID = #{userId}
		<include refid="mySearch" />
	</select>

	<select id="SelectAssetInfoVO"
		parameterType="egovframework.let.ass.service.AssetManageVO"
		resultMap="assetInfoDetail">
		SELECT 
			A.ASSET_ID,
			C.CAT_NAME AS LARGE_CATEGORY, 
			D.CAT_NAME AS MIDDLE_CATEGORY,
			A.ASSET_NAME,
			A.ASSET_QTY,
			DATE_FORMAT(A.ACQUIRED_DATE,'%Y-%m-%d') AS ACQUIRED_DATE,
			A.ACQUIRED_PRICE,
			A.MAKER,
			A.NOTE,
			DATE_FORMAT(A.REG_DATE,'%Y-%m-%d') AS REG_DATE,
			A.ASSET_SN,
			A.FILE_ID,
			G.ORGNZT_NM AS ORGNZT_ID,
			B.PRJ_ID,
			H.PRJ_NAME AS PRJ_NM,
			B.USE_ID,
			E.USER_NM AS USE_NM,
			DATE_FORMAT(B.RCPT_DATE,'%Y-%m-%d') AS RCPT_DATE,
			B.RCPT_ID,
			F.USER_NM AS RCPT_NM,
			B.CARRY_REASON
		  FROM ASSETSINFO A
		  LEFT OUTER JOIN ASSETSHIST B
		    ON A.ASSET_ID = B.ASSET_ID
		  LEFT OUTER JOIN CATEGORY C
	    	ON A.LARGE_CATEGORY = C.CAT_ID
		  LEFT OUTER JOIN CATEGORY D
		    ON A.MIDDLE_CATEGORY = D.CAT_ID
	      LEFT OUTER JOIN LETTNEMPLYRINFO E
	        ON B.USE_ID = E.ESNTL_ID
	      LEFT OUTER JOIN LETTNEMPLYRINFO F
	        ON B.RCPT_ID = F.ESNTL_ID  
	      LEFT OUTER JOIN LETTNORGNZTINFO G
	        ON B.ORGNZT_ID = G.ORGNZT_ID
	      LEFT OUTER JOIN PROJECTS H
	        ON B.PRJ_ID = H.PRJ_ID
		 WHERE A.ASSET_ID = #{assetId}
	</select>

	<insert id="InsertAssetInfo"
		parameterType="egovframework.let.ass.service.AssetInfoVO">
	
		INSERT INTO ASSETSINFO (
		    ASSET_ID, 
		    LARGE_CATEGORY, 
		    MIDDLE_CATEGORY, 
		    ASSET_QTY,
		    ASSET_NAME,
		    ASSET_SN,
		    MAKER, 
		    NOTE,
		    ACQUIRED_DATE, 
		    ACQUIRED_PRICE, 
		    REG_ID, 
		    REG_DATE, 
		    USAGE_STAUTS
		    )
		VALUES (
		    #{assetId},
		    #{largeCategory},
		    #{middleCategory}, 
		    #{assetQty},
		    #{assetName},
		    #{assetSn},
		    #{maker},
		    #{note},
		    NULL,
		    '',
		    #{regId},
		    DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s'),
		    #{usageStatus} 
		     )
	</insert>

	<update id="UpdateAssetInfo" parameterType="egovframework.let.ass.service.AssetInfoVO">
		UPDATE 
			ASSETSINFO
		   SET 
		    LARGE_CATEGORY = #{largeCategory}, 
		    MIDDLE_CATEGORY = #{middleCategory}, 
		    ASSET_QTY = #{assetQty}, 
		    ASSET_NAME = #{assetName},
		    ASSET_SN = #{assetSn},
		    MAKER = #{maker},  
		    NOTE = #{note},
		    <if test="acquiredDate != null and acquiredDate != ''">
		    ACQUIRED_DATE = STR_TO_DATE(#{acquiredDate}, '%Y-%m-%d'), 
		    </if>
		    ACQUIRED_PRICE = #{acquiredPrice}
		 WHERE ASSET_ID = #{assetId}
	</update>
	 
	<select id="xlsxTrsfAssetList"
		parameterType="egovframework.let.ass.service.AssetManageVO"
		resultType="egovMap">
		
	    SELECT 
	    	   IFNULL(LARGE_CATEGORY,'') LARGE_CATEGORY, 
	    	   IFNULL(MIDDLE_CATEGORY, '') MIDDLE_CATEGORY,
	    	   IFNULL(ASSET_NAME, '') ASSET_NAME,
	    	   IFNULL(ASSET_QTY, '') ASSET_QTY,
	    	   IFNULL(ACQUIRED_DATE,'') ACQUIRED_DATE,
	    	   IFNULL(ACQUIRED_PRICE,'') ACQUIRED_PRICE,
	    	   IFNULL(REG_DATE,'') REG_DATE,
	    	   IFNULL(USAGE_STAUTS,'') USAGE_STAUTS
	      FROM (
		        SELECT 
					ROW_NUMBER() OVER(ORDER BY A.REG_DATE DESC)AS RUM,
					A.ASSET_ID,
					C.CAT_NAME AS LARGE_CATEGORY, 
					D.CAT_NAME AS MIDDLE_CATEGORY,
					A.ASSET_NAME,
					A.ASSET_QTY, 
					DATE_FORMAT(A.ACQUIRED_DATE,'%Y-%m-%d') AS ACQUIRED_DATE, 
					A.ACQUIRED_PRICE, 
					DATE_FORMAT(A.REG_DATE,'%Y-%m-%d') AS REG_DATE, 
					E.CODE_NM AS USAGE_STAUTS
				  FROM ASSETSINFO A
				  LEFT OUTER JOIN ASSETSHIST B
				    ON A.ASSET_ID = B.ASSET_ID
				  LEFT OUTER JOIN CATEGORY C
				    ON A.LARGE_CATEGORY = C.CAT_ID
				  LEFT OUTER JOIN CATEGORY D
				    ON A.MIDDLE_CATEGORY = D.CAT_ID
				  LEFT OUTER JOIN LETTCCMMNDETAILCODE E
				    ON A.USAGE_STAUTS = E.CODE
				  LEFT OUTER JOIN LETTCCMMNDETAILCODE F
				    ON B.APPROVAL = F.CODE
		        	<include refid="search" />
		    ) P 
	    WHERE P.RUM BETWEEN #{first} AND #{last}
	</select>
	
	<select id="xlsxTrsfMyAssList" parameterType="egovframework.let.ass.service.AssetManageVO" resultType="egovMap">
	    SELECT IFNULL(LARGE_CATEGORY,'') LARGE_CATEGORY, 
	    	   IFNULL(MIDDLE_CATEGORY, '') MIDDLE_CATEGORY,
	    	   IFNULL(ASSET_NAME, '') ASSET_NAME,
	    	   IFNULL(ASSET_QTY, '') ASSET_QTY,
	    	   IFNULL(PRJ_ID, '') PRJ_ID,
	    	   IFNULL(REG_DATE, '') REG_DATE,
	    	   IFNULL(USAGE_STAUTS,'') USAGE_STAUTS
	      FROM (SELECT ROW_NUMBER() OVER(ORDER BY A.REG_DATE DESC)AS RUM,
					   C.CAT_NAME AS LARGE_CATEGORY, 
					   D.CAT_NAME AS MIDDLE_CATEGORY,
					   A.ASSET_NAME,
					   A.ASSET_QTY,
					   G.PRJ_NAME AS PRJ_ID,
					   DATE_FORMAT(A.REG_DATE,'%Y-%m-%d') AS REG_DATE, 
					   E.CODE_NM AS USAGE_STAUTS
				  FROM ASSETSINFO A
	   LEFT OUTER JOIN ASSETSHIST B
				    ON A.ASSET_ID = B.ASSET_ID
	   LEFT OUTER JOIN CATEGORY C
				    ON A.LARGE_CATEGORY = C.CAT_ID
	   LEFT OUTER JOIN CATEGORY D
				    ON A.MIDDLE_CATEGORY = D.CAT_ID
	   LEFT OUTER JOIN LETTCCMMNDETAILCODE E
				    ON A.USAGE_STAUTS = E.CODE
	   LEFT OUTER JOIN LETTCCMMNDETAILCODE F
				    ON B.APPROVAL = F.CODE
	   LEFT OUTER JOIN PROJECTS G
				    ON B.PRJ_ID = G.PRJ_ID
				 WHERE B.USE_ID = #{userId}
		        <include refid="mySearch" />) P 
	    WHERE P.RUM BETWEEN #{first} AND #{last}
	</select>
</mapper>